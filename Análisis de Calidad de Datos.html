<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Calidad de Datos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #0f3460;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 1px solid #1e3a5f;
        }

        .header {
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 3px solid #4a69bd;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            color: #a5b1c2;
        }

        .main-content {
            display: flex;
            min-height: 700px;
        }

        .upload-section {
            flex: 0 0 350px;
            padding: 30px;
            background: #1b1b2f;
            border-right: 1px solid #2d4059;
            display: flex;
            flex-direction: column;
        }

        .report-section {
            flex: 1;
            padding: 30px;
            background: #162447;
            overflow-y: auto;
            max-height: 800px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .upload-area {
            border: 2px dashed #4a69bd;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background: rgba(26, 26, 46, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #78e08f;
            background: rgba(120, 224, 143, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(120, 224, 143, 0.2);
        }

        .upload-area.dragover {
            border-color: #78e08f;
            background: rgba(120, 224, 143, 0.2);
        }

        .upload-icon {
            font-size: 48px;
            color: #78e08f;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 8px rgba(120, 224, 143, 0.4));
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            display: inline-block;
            background: linear-gradient(135deg, #4a69bd 0%, #1e3799 100%);
            color: white;
            padding: 12px 30px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            border: none;
            font-size: 1em;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .upload-btn:hover {
            background: linear-gradient(135deg, #78e08f 0%, #38ada9 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(120, 224, 143, 0.4);
        }

        .file-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(74, 105, 189, 0.2);
            border-radius: 5px;
            display: none;
            border-left: 4px solid #78e08f;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .file-info.show {
            display: block;
        }

        .clear-file {
            background: #e55039;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            float: right;
            transition: all 0.3s ease;
        }

        .clear-file:hover {
            background: #eb3b5a;
            transform: rotate(90deg);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px 20px;
            background: rgba(26, 26, 46, 0.8);
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #4a69bd;
        }

        .loading.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .spinner {
            border: 4px solid rgba(74, 105, 189, 0.3);
            border-top: 4px solid #78e08f;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
            box-shadow: 0 0 15px rgba(120, 224, 143, 0.3);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4a69bd;
        }

        .download-btn {
            background: linear-gradient(135deg, #78e08f 0%, #38ada9 100%);
            color: #1a1a2e;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            display: none;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            border: none;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .download-btn:hover {
            background: linear-gradient(135deg, #38ada9 0%, #78e08f 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(120, 224, 143, 0.4);
        }

        .download-btn:active {
            transform: translateY(0);
        }

        .report-content {
            line-height: 1.8;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            color: #e0e0e0;
        }

        .footer {
            text-align: center;
            padding: 20px;
            background: #0c2461;
            color: #a5b1c2;
            margin-top: 20px;
            border-radius: 0 0 10px 10px;
            font-size: 0.9em;
            border-top: 1px solid #1e3a5f;
        }

        /* Estilos espec√≠ficos para el formato del informe */
        .report-text {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .console-message {
            background: rgba(26, 26, 46, 0.8);
            color: #78e08f;
            padding: 12px 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-left: 4px solid #78e08f;
            animation: slideIn 0.3s ease;
        }

        .console-warning {
            background: rgba(245, 171, 53, 0.1);
            color: #f5ab35;
            padding: 12px 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-left: 4px solid #f5ab35;
            animation: slideIn 0.3s ease;
        }

        .console-error {
            background: rgba(231, 80, 57, 0.1);
            color: #e75039;
            padding: 12px 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-left: 4px solid #e75039;
            animation: slideIn 0.3s ease;
        }

        .console-info {
            background: rgba(74, 105, 189, 0.1);
            color: #4a69bd;
            padding: 12px 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-left: 4px solid #4a69bd;
            animation: slideIn 0.3s ease;
        }

        .warning {
            color: #e75039;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(231, 80, 57, 0.3);
        }

        .check {
            color: #78e08f;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(120, 224, 143, 0.3);
        }

        .info-box {
            background: rgba(74, 105, 189, 0.2);
            border-left: 4px solid #78e08f;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #a5b1c2;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            border: 1px solid #4a69bd;
            background: rgba(26, 26, 46, 0.5);
        }

        .data-table th {
            background: rgba(74, 105, 189, 0.3);
            color: #78e08f;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #4a69bd;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .data-table td {
            padding: 8px 10px;
            border: 1px solid #4a69bd;
            color: #e0e0e0;
        }

        .data-table tr:nth-child(even) {
            background: rgba(74, 105, 189, 0.1);
        }

        .data-table tr:hover {
            background: rgba(120, 224, 143, 0.1);
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .status-success {
            background: rgba(120, 224, 143, 0.2);
            color: #78e08f;
            border: 1px solid rgba(120, 224, 143, 0.3);
        }

        .status-error {
            background: rgba(231, 80, 57, 0.2);
            color: #e75039;
            border: 1px solid rgba(231, 80, 57, 0.3);
        }

        .glow {
            text-shadow: 0 0 10px currentColor;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .terminal-header {
            background: linear-gradient(90deg, #1a1a2e, #16213e);
            padding: 10px 15px;
            border-radius: 5px 5px 0 0;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #78e08f;
            border-bottom: 2px solid #4a69bd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .terminal-dots {
            display: flex;
            gap: 8px;
        }

        .terminal-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .terminal-dot.red { background: #e75039; }
        .terminal-dot.yellow { background: #f5ab35; }
        .terminal-dot.green { background: #78e08f; }

        .system-info {
            color: #4a69bd;
            font-size: 0.8em;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç SISTEMA DE AN√ÅLISIS DE CALIDAD DE DATOS</h1>
            <p>An√°lisis exhaustivo de integridad, coherencia y anomal√≠as en conjuntos de datos</p>
        </div>
        
        <div class="main-content">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <h3 style="color: #78e08f; margin-bottom: 10px;">SUBE TU ARCHIVO</h3>
                    <p style="color: #a5b1c2; margin-bottom: 10px;">CSV o Excel (.xlsx, .xls)</p>
                    <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        SELECCIONAR ARCHIVO
                    </button>
                    <div class="info-box" style="margin-top: 20px;">
                        <strong>üìã FORMATO DE SALIDA:</strong><br>
                        ‚Ä¢ An√°lisis estructurado profesional<br>
                        ‚Ä¢ Informe exhaustivo de calidad<br>
                        ‚Ä¢ Descarga autom√°tica en TXT
                    </div>
                </div>
                
                <div class="file-info" id="fileInfo">
                    <button class="clear-file" onclick="clearFile()" title="Eliminar archivo">
                        √ó
                    </button>
                    <strong id="fileName" style="font-size: 1em; color: #78e08f;"></strong>
                    <p id="fileSize" style="color: #a5b1c2; margin-top: 5px; font-size: 0.9em;"></p>
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <h3 style="color: #78e08f; margin-bottom: 10px;">ANALIZANDO DATOS...</h3>
                    <p id="loadingText" style="color: #a5b1c2;">Generando informe de calidad</p>
                </div>

                <div id="downloadSection" style="display: none; margin-top: 20px;">
                    <button class="download-btn" id="downloadTxtBtn" style="display: block; width: 100%;">
                        ‚¨á DESCARGAR INFORME TXT
                    </button>
                    <p style="font-size: 0.9em; color: #a5b1c2; margin-top: 10px; text-align: center; font-family: 'Courier New', monospace;">
                        informe_calidad_datos_[nombre].txt
                    </p>
                </div>
            </div>
            
            <div class="report-section">
                <div class="terminal-header">
                    <div class="terminal-dots">
                        <div class="terminal-dot red"></div>
                        <div class="terminal-dot yellow"></div>
                        <div class="terminal-dot green"></div>
                    </div>
                    <div>CONSOLA DE AN√ÅLISIS</div>
                    <div class="system-info">V1.0</div>
                </div>
                
                <div class="report-content" id="reportContent">
                    <div class="console-info">
                        <strong>‚ñ∂ SISTEMA DE AN√ÅLISIS DE CALIDAD DE DATOS INICIADO</strong><br>
                        Versi√≥n 1.0 ‚Ä¢ An√°lisis exhaustivo de datos
                    </div>
                    <div class="console-message">
                        <strong>‚ñ∂ Por favor, suba un archivo CSV o Excel para generar un informe de calidad de datos:</strong>
                    </div>
                    <div style="margin-top: 20px; color: #a5b1c2; font-size: 0.9em; text-align: center;">
                        <p>Este sistema genera informes exhaustivos para ofrecer una visi√≥n clara y detallada<br>de la calidad de los datos en su conjunto de datos.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Sistema de An√°lisis de Calidad de Datos ‚Ä¢ An√°lisis exhaustivo de integridad y coherencia ‚Ä¢ Versi√≥n 1.0</p>
        </div>
    </div>

    <script>
        // Variables globales
        let currentData = null;
        let currentFileName = '';
        let currentFileExtension = '';
        let reportText = '';
        let consoleMessages = [];
        
        // Elementos DOM
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const reportContent = document.getElementById('reportContent');
        const downloadSection = document.getElementById('downloadSection');
        const downloadTxtBtn = document.getElementById('downloadTxtBtn');

        // Manejo de eventos de arrastrar y soltar
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });

        // Funci√≥n para agregar mensajes a la consola
        function addConsoleMessage(message, type = 'info') {
            consoleMessages.push({ message, type, timestamp: new Date() });
            updateConsoleDisplay();
        }

        // Actualizar la visualizaci√≥n de la consola
        function updateConsoleDisplay() {
            let html = '';
            
            // Mostrar todos los mensajes de consola
            consoleMessages.forEach(msg => {
                const time = msg.timestamp.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                switch(msg.type) {
                    case 'success':
                        html += `<div class="console-message">[${time}] ${msg.message}</div>`;
                        break;
                    case 'warning':
                        html += `<div class="console-warning">[${time}] ${msg.message}</div>`;
                        break;
                    case 'error':
                        html += `<div class="console-error">[${time}] ${msg.message}</div>`;
                        break;
                    default:
                        html += `<div class="console-info">[${time}] ${msg.message}</div>`;
                }
            });
            
            reportContent.innerHTML = html;
            // Auto-scroll al final
            reportContent.scrollTop = reportContent.scrollHeight;
        }

        // Funci√≥n para manejar archivo seleccionado
        function handleFile(file) {
            if (!file) return;
            
            // Validar tama√±o m√°ximo (50 MB)
            const maxSize = 50 * 1024 * 1024;
            if (file.size > maxSize) {
                addConsoleMessage(`ERROR: El archivo es demasiado grande. Tama√±o m√°ximo: 50 MB`, 'error');
                return;
            }
            
            currentFileName = file.name;
            currentFileExtension = file.name.split('.').pop().toLowerCase();
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            
            // Limpiar mensajes anteriores
            consoleMessages = [];
            
            // Mostrar informaci√≥n del archivo
            fileName.textContent = file.name;
            fileSize.textContent = `${fileSizeMB} MB`;
            fileInfo.classList.add('show');
            
            // Ocultar secci√≥n de descarga anterior
            downloadSection.style.display = 'none';
            
            // Preparar para an√°lisis
            loading.classList.add('show');
            loadingText.textContent = 'Leyendo archivo...';
            
            // Mostrar mensaje inicial en la consola
            addConsoleMessage(`¬°Archivo '${file.name}' cargado exitosamente!`, 'success');
            addConsoleMessage('Conjunto de datos cargado. Generando informe de calidad de datos...', 'info');
            
            // Leer y procesar el archivo
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    loadingText.textContent = 'Procesando datos...';
                    
                    let df = null;
                    
                    if (currentFileExtension === 'csv') {
                        addConsoleMessage('Leyendo archivo CSV...', 'info');
                        df = await parseCSV(e.target.result);
                    } else if (currentFileExtension === 'xlsx' || currentFileExtension === 'xls') {
                        addConsoleMessage('Leyendo archivo Excel...', 'info');
                        df = await parseExcel(e.target.result);
                    } else {
                        addConsoleMessage('ERROR: Formato de archivo no compatible. Use CSV (.csv) o Excel (.xlsx, .xls)', 'error');
                        return;
                    }
                    
                    addConsoleMessage('‚úì Archivo le√≠do correctamente', 'success');
                    loadingText.textContent = 'Generando informe...';
                    
                    if (df) {
                        currentData = df;
                        await generateQualityReport(df);
                        
                        // Generar y descargar autom√°ticamente el archivo TXT
                        await downloadTxtReport();
                        
                        // Mostrar √©xito
                        addConsoleMessage('‚úì Informe generado y guardado exitosamente', 'success');
                    }
                } catch (error) {
                    addConsoleMessage(`ERROR al procesar el archivo: ${error.message}`, 'error');
                } finally {
                    setTimeout(() => {
                        loading.classList.remove('show');
                    }, 500);
                }
            };
            
            if (currentFileExtension === 'csv') {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        // Parser de CSV usando PapaParse
        async function parseCSV(text) {
            return new Promise((resolve, reject) => {
                Papa.parse(text, {
                    header: true,
                    dynamicTyping: false,
                    skipEmptyLines: true,
                    complete: (results) => {
                        addConsoleMessage(`‚úì CSV analizado: ${results.data.length} filas, ${results.meta.fields?.length || 0} columnas`, 'success');
                        const df = {
                            data: results.data,
                            columns: results.meta.fields || [],
                            shape: [results.data.length, results.meta.fields?.length || 0],
                            
                            isnull: function() {
                                const missing = {};
                                this.columns.forEach(col => {
                                    missing[col] = this.data.filter(row => 
                                        row[col] === null || row[col] === undefined || row[col] === ''
                                    ).length;
                                });
                                return missing;
                            },
                            
                            duplicated: function(subset = null, keep = 'first') {
                                const seen = new Set();
                                const duplicates = [];
                                
                                this.data.forEach((row, idx) => {
                                    const key = subset ? 
                                        subset.map(col => row[col]).join('|') :
                                        Object.values(row).join('|');
                                    
                                    if (seen.has(key)) {
                                        if (keep !== 'first') {
                                            duplicates.push(idx);
                                        }
                                    } else {
                                        seen.add(key);
                                    }
                                });
                                
                                return duplicates.length;
                            },
                            
                            getColumn: function(col) {
                                return this.data.map(row => row[col]);
                            }
                        };
                        
                        resolve(df);
                    },
                    error: (error) => {
                        addConsoleMessage(`ERROR al analizar CSV: ${error.message}`, 'error');
                        reject(error);
                    }
                });
            });
        }

        // Parser de Excel usando SheetJS
        async function parseExcel(buffer) {
            try {
                const workbook = XLSX.read(buffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                const headers = data[0];
                const rows = data.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, idx) => {
                        obj[header] = row[idx] !== undefined ? row[idx] : '';
                    });
                    return obj;
                });
                
                addConsoleMessage(`‚úì Excel analizado: ${rows.length} filas, ${headers.length} columnas`, 'success');
                
                const df = {
                    data: rows,
                    columns: headers,
                    shape: [rows.length, headers.length],
                    
                    isnull: function() {
                        const missing = {};
                        this.columns.forEach(col => {
                            missing[col] = this.data.filter(row => 
                                row[col] === null || row[col] === undefined || row[col] === ''
                            ).length;
                        });
                        return missing;
                    },
                    
                    duplicated: function(subset = null, keep = 'first') {
                        const seen = new Set();
                        const duplicates = [];
                        
                        this.data.forEach((row, idx) => {
                            const key = subset ? 
                                subset.map(col => row[col]).join('|') :
                                Object.values(row).join('|');
                            
                            if (seen.has(key)) {
                                if (keep !== 'first') {
                                    duplicates.push(idx);
                                }
                            } else {
                                seen.add(key);
                            }
                        });
                        
                        return duplicates.length;
                    },
                    
                    getColumn: function(col) {
                        return this.data.map(row => row[col]);
                    }
                };
                
                return df;
            } catch (error) {
                addConsoleMessage(`ERROR al analizar Excel: ${error.message}`, 'error');
                throw error;
            }
        }

        // Funci√≥n principal para generar el informe de calidad
        async function generateQualityReport(df) {
            reportText = '';
            
            // 1. Encabezado del informe
            reportText += "=".repeat(50) + "\n";
            reportText += "INFORME DE CALIDAD DE DATOS DEL DATASET\n";
            reportText += "=".repeat(50) + "\n";
            reportText += "Este informe exhaustivo ha sido generado para ofrecer una visi√≥n clara y detallada de la calidad de los datos en su conjunto de datos. A continuaci√≥n, encontrar√° un an√°lisis estructurado que abarca la integridad, coherencia y posibles problemas de anomal√≠as, facilitando una revisi√≥n eficiente y la toma de decisiones informadas.\n\n";

            // 2. Informaci√≥n General
            reportText += "**1. INFORMACI√ìN GENERAL DEL DATASET**\n";
            reportText += `  - Forma del conjunto de datos: ${df.shape[0]} Filas √ó ${df.shape[1]} Columnas\n\n`;
            
            // 3. An√°lisis de valores faltantes
            reportText += "**2. AN√ÅLISIS DE VALORES FALTANTES**\n";
            const missing = df.isnull();
            const missingTotal = Object.values(missing).reduce((a, b) => a + b, 0);
            
            let colsWithMissing = [];
            Object.entries(missing).forEach(([col, count]) => {
                if (count > 0) colsWithMissing.push({ col, count });
            });
            
            if (colsWithMissing.length > 0) {
                colsWithMissing.forEach(({ col, count }) => {
                    const pct = ((count / df.shape[0]) * 100).toFixed(1);
                    reportText += `  - Columna '${col}': ${count} valores faltantes (${pct}% del total)\n`;
                    
                    // Encontrar filas con valores faltantes
                    const missingIndices = [];
                    df.data.forEach((row, idx) => {
                        if (row[col] === null || row[col] === undefined || row[col] === '') {
                            missingIndices.push(idx + 2); // +2 para filas de Excel
                        }
                    });
                    
                    if (missingIndices.length > 0) {
                        reportText += `    Filas de Excel con valores faltantes: ${missingIndices.join(', ')}\n`;
                    }
                });
                
                reportText += `\n  Se han identificado valores faltantes en ${colsWithMissing.length} columna(s). Se recomienda investigar y tratar estos valores para asegurar la completitud de los datos.\n\n`;
            } else {
                reportText += "  ‚úì No se encontraron valores faltantes en ninguna columna.\n\n";
            }
            
            // 4. AN√ÅLISIS DE FILAS DUPLICADOS
            reportText += "**3. AN√ÅLISIS DE FILAS DUPLICADAS**\n";
            
            let duplicateCCs = [];
            let inconsistencies = [];
            let duplicatesCount = 0;
            
            if (!df.columns.includes('CC')) {
                reportText += "  ADVERTENCIA: La columna 'CC' no fue encontrada. La detecci√≥n de duplicados se realizar√° considerando todas las columnas del dataset.\n";
                duplicatesCount = df.duplicated(null, 'first');
                reportText += `  Total de filas duplicadas (excluyendo la primera ocurrencia): ${duplicatesCount}\n`;
            } else {
                // Calcular duplicados basados en CC
                const ccGroups = {};
                df.data.forEach((row, idx) => {
                    if (row.CC !== undefined && row.CC !== null && row.CC !== '') {
                        const ccValue = row.CC;
                        if (!ccGroups[ccValue]) {
                            ccGroups[ccValue] = [];
                        }
                        ccGroups[ccValue].push(idx + 2); // +2 para filas de Excel
                    }
                });
                
                // Filtrar solo los duplicados
                duplicateCCs = Object.entries(ccGroups)
                    .filter(([_, indices]) => indices.length > 1)
                    .sort((a, b) => b[1].length - a[1].length);
                
                // Calcular duplicados totales (excluyendo primera ocurrencia)
                duplicatesCount = duplicateCCs.reduce((total, [_, indices]) => total + (indices.length - 1), 0);
                
                reportText += `  Total de filas con 'CC' duplicado (excluyendo la primera ocurrencia): ${duplicatesCount}\n`;
                
                if (duplicatesCount > 0) {
                    reportText += `  Se identificaron ${duplicatesCount} filas donde el valor de 'CC' est√° duplicado, consider√°ndose una llave primaria. A continuaci√≥n se detallan los valores de 'CC' duplicados y las filas de Excel donde aparecen (presentado en formato de tabla para mejor lectura):\n\n`;
                    
                    if (duplicateCCs.length > 0) {
                        // Crear tabla alineada
                        const tableData = [];
                        let maxCCLength = "Valor de CC".length;
                        let maxOccLength = "Ocurrencias".length;
                        let maxRowsLength = "Filas de Excel".length;
                        
                        // Procesar datos para la tabla
                        duplicateCCs.forEach(([cc, indices]) => {
                            const ccStr = typeof cc === 'number' ? cc.toFixed(1) : String(cc);
                            const occStr = String(indices.length);
                            const rowsStr = indices.join(', ');
                            
                            maxCCLength = Math.max(maxCCLength, ccStr.length);
                            maxOccLength = Math.max(maxOccLength, occStr.length);
                            maxRowsLength = Math.max(maxRowsLength, rowsStr.length);
                            
                            tableData.push({ cc: ccStr, occurrences: occStr, rows: rowsStr, originalIndices: indices });
                        });
                        
                        // Encabezado de tabla
                        reportText += " ".repeat(2);
                        reportText += "Valor de CC".padEnd(maxCCLength + 4);
                        reportText += "Ocurrencias".padEnd(maxOccLength + 4);
                        reportText += "Filas de Excel\n";
                        
                        // Filas de tabla
                        tableData.forEach(row => {
                            reportText += " ".repeat(2);
                            reportText += row.cc.padEnd(maxCCLength + 4);
                            reportText += row.occurrences.padEnd(maxOccLength + 4);
                            reportText += row.rows + "\n";
                            
                            // Verificar inconsistencias para este CC
                            const indices = row.originalIndices.map(idx => idx - 2);
                            const rows = indices.map(idx => df.data[idx]);
                            
                            if (rows.length > 1) {
                                const firstRow = { ...rows[0] };
                                delete firstRow.CC;
                                
                                const allSame = rows.every(row => {
                                    const rowCopy = { ...row };
                                    delete rowCopy.CC;
                                    return Object.keys(firstRow).every(key => 
                                        String(rowCopy[key]).trim() === String(firstRow[key]).trim()
                                    );
                                });
                                
                                if (!allSame) {
                                    inconsistencies.push({
                                        cc: row.cc,
                                        indices: row.originalIndices,
                                        names: rows.map(r => {
                                            for (let key in r) {
                                                if (key.toLowerCase().includes('nombre') && r[key]) {
                                                    return r[key];
                                                }
                                            }
                                            return null;
                                        }).filter(n => n)
                                    });
                                }
                            }
                        });
                        reportText += "\n";
                        
                        // Mostrar advertencia de inconsistencia si existe
                        if (inconsistencies.length > 0) {
                            reportText += "  ***ADVERTENCIA DE INCONSISTENCIA CR√çTICA***\n";
                            reportText += `  Se encontraron ${inconsistencies.length} valores de 'CC' que se repiten, pero los dem√°s datos asociados a esos 'CC' son **DIFERENTES**. Esto indica problemas graves de integridad de datos que requieren una revisi√≥n URGENTE.\n`;
                            reportText += "  **Detalles de las inconsistencias:**\n\n";
                            
                            // Crear tabla de inconsistencias
                            let incTableData = [];
                            let maxIncCCLength = "CC Inconsistente".length;
                            let maxIncOccLength = "Ocurrencias".length;
                            let maxIncRowsLength = "Filas de Excel".length;
                            let maxIncNamesLength = "Nombres Asociados".length;
                            
                            inconsistencies.forEach(({ cc, indices, names }) => {
                                const occStr = String(indices.length);
                                const rowsStr = indices.join(', ');
                                const namesStr = names.length > 0 ? names.join(', ') : "No se encontr√≥ columna 'nombre'.";
                                
                                maxIncCCLength = Math.max(maxIncCCLength, cc.length);
                                maxIncOccLength = Math.max(maxIncOccLength, occStr.length);
                                maxIncRowsLength = Math.max(maxIncRowsLength, rowsStr.length);
                                maxIncNamesLength = Math.max(maxIncNamesLength, namesStr.length);
                                
                                incTableData.push({ 
                                    cc: cc, 
                                    occurrences: occStr, 
                                    rows: rowsStr, 
                                    names: namesStr 
                                });
                            });
                            
                            // Encabezado tabla inconsistencias
                            reportText += " ".repeat(2);
                            reportText += "CC Inconsistente".padEnd(maxIncCCLength + 4);
                            reportText += "Ocurrencias".padEnd(maxIncOccLength + 4);
                            reportText += "Filas de Excel".padEnd(maxIncRowsLength + 4);
                            reportText += "Nombres Asociados\n";
                            
                            // Filas tabla inconsistencias
                            incTableData.forEach(row => {
                                reportText += " ".repeat(2);
                                reportText += row.cc.padEnd(maxIncCCLength + 4);
                                reportText += row.occurrences.padEnd(maxIncOccLength + 4);
                                reportText += row.rows.padEnd(maxIncRowsLength + 4);
                                reportText += row.names + "\n";
                            });
                            reportText += "\n";
                        }
                    }
                } else {
                    reportText += `  ‚úì No se encontraron valores 'CC' duplicados.\n\n`;
                }
            }
            
            // 5. RESUMEN DE TIPOS DE DATOS
            reportText += "**4. RESUMEN DE TIPOS DE DATOS**\n";
            
            // Detectar tipos de datos
            const typeCounts = { 'object': 0, 'float64': 0, 'int64': 0 };
            df.columns.forEach(col => {
                const sampleValues = df.getColumn(col).slice(0, 10).filter(v => v !== null && v !== undefined && v !== '');
                if (sampleValues.length > 0) {
                    const allNumbers = sampleValues.every(v => !isNaN(parseFloat(v)) && isFinite(v));
                    if (allNumbers) {
                        const allIntegers = sampleValues.every(v => {
                            const num = parseFloat(v);
                            return Number.isInteger(num) && !String(v).includes('.');
                        });
                        if (allIntegers) {
                            typeCounts['int64']++;
                        } else {
                            typeCounts['float64']++;
                        }
                    } else {
                        typeCounts['object']++;
                    }
                } else {
                    typeCounts['object']++;
                }
            });
            
            // Mostrar solo tipos que tienen columnas
            Object.entries(typeCounts).forEach(([dtype, count]) => {
                if (count > 0) {
                    reportText += `  - Tipo '${dtype}': ${count} columna(s)\n`;
                }
            });
            reportText += "\n";
            
            // 6. AN√ÅLISIS DE TIPOS DE DATOS MEZCLADOS
            reportText += "**5. AN√ÅLISIS DE TIPOS DE DATOS MEZCLADOS (Columnas 'Object')**\n";
            
            const objectCols = df.columns.filter(col => {
                const sampleValues = df.getColumn(col).slice(0, 10).filter(v => v !== null && v !== undefined && v !== '');
                if (sampleValues.length === 0) return false;
                const allNumbers = sampleValues.every(v => !isNaN(parseFloat(v)) && isFinite(v));
                return !allNumbers;
            });
            
            const mixedTypeCols = [];
            objectCols.forEach(col => {
                const values = df.getColumn(col).filter(v => v !== null && v !== undefined && v !== '');
                if (values.length > 1) {
                    let hasNumbers = false;
                    let hasStrings = false;
                    
                    values.forEach(val => {
                        const strVal = String(val).trim();
                        if (strVal !== '' && !isNaN(parseFloat(strVal)) && isFinite(strVal)) {
                            hasNumbers = true;
                        } else if (strVal !== '') {
                            hasStrings = true;
                        }
                    });
                    
                    if (hasNumbers && hasStrings) {
                        mixedTypeCols.push(`  - Columna '${col}': Contiene tipos mezclados: int, str\n`);
                    }
                }
            });
            
            if (mixedTypeCols.length > 0) {
                mixedTypeCols.forEach(line => reportText += line);
                reportText += "\n  Se han identificado columnas con tipos de datos inconsistentes. Se recomienda estandarizar los tipos de datos para evitar errores en an√°lisis futuros.\n\n";
            } else {
                reportText += "  ‚úì No se encontraron columnas de tipo 'object' con tipos de datos mezclados significativos.\n\n";
            }
            
            // 7. AN√ÅLISIS DE VALORES AT√çPICOS
            reportText += "**6. AN√ÅLISIS DE VALORES AT√çPICOS NUM√âRICOS (M√©todo IQR)**\n";
            
            const numericCols = df.columns.filter(col => {
                const sampleValues = df.getColumn(col).slice(0, 5).filter(v => v !== null && v !== undefined && v !== '');
                if (sampleValues.length === 0) return false;
                return sampleValues.every(v => !isNaN(parseFloat(v)) && isFinite(v));
            });
            
            if (numericCols.length > 0) {
                let outliersFound = false;
                
                numericCols.forEach(col => {
                    const values = df.getColumn(col)
                        .filter(v => v !== null && v !== undefined && v !== '')
                        .map(v => parseFloat(v))
                        .filter(v => !isNaN(v));
                    
                    if (values.length >= 4) {
                        const sorted = values.slice().sort((a, b) => a - b);
                        const q1 = sorted[Math.floor(sorted.length * 0.25)];
                        const q3 = sorted[Math.floor(sorted.length * 0.75)];
                        const iqr = q3 - q1;
                        
                        if (iqr > 0) {
                            const lower = q1 - 1.5 * iqr;
                            const upper = q3 + 1.5 * iqr;
                            const outliers = values.filter(v => v < lower || v > upper);
                            
                            if (outliers.length > 0) {
                                reportText += `  - Columna '${col}': ${outliers.length} posibles valores at√≠picos\n`;
                                outliersFound = true;
                            }
                        }
                    }
                });
                
                if (!outliersFound) {
                    reportText += "  ‚úì No se encontraron valores at√≠picos significativos en columnas num√©ricas.\n\n";
                } else {
                    reportText += "\n  Se han detectado posibles valores at√≠picos en columnas num√©ricas. Se sugiere una revisi√≥n para determinar si son errores de entrada o variaciones leg√≠timas de los datos.\n\n";
                }
            } else {
                reportText += "  ‚úì No se encontraron columnas num√©ricas para an√°lisis de valores at√≠picos.\n\n";
            }
            
            // 8. Pie del informe
            reportText += "=".repeat(50) + "\n";
            reportText += "FIN DEL INFORME DE CALIDAD DE DATOS\n";
            reportText += "Esperamos que este Informe de Calidad de Datos le sea de gran utilidad para comprender mejor la situaci√≥n de su dataset. Se recomienda encarecidamente revisar los hallazgos detallados y tomar las acciones correctivas necesarias para garantizar la m√°xima integridad y fiabilidad de sus datos. ¬°Gracias por utilizar nuestro servicio de an√°lisis de calidad de datos!\n\n";
            
            // Agregar el informe completo a la consola
            addConsoleMessage("=".repeat(50), 'info');
            addConsoleMessage("INFORME DE CALIDAD DE DATOS DEL DATASET", 'info');
            addConsoleMessage("=".repeat(50), 'info');
            addConsoleMessage("‚úì Informe generado exitosamente", 'success');
            
            // Mostrar resumen en la consola
            const summaryLines = reportText.split('\n').slice(0, 20);
            summaryLines.forEach(line => {
                if (line.trim() !== '') {
                    addConsoleMessage(line, 'info');
                }
            });
            addConsoleMessage("... (informe completo disponible para descarga)", 'info');
        }

        // Descargar autom√°ticamente el informe en TXT
        async function downloadTxtReport() {
            // Crear nombre de archivo
            const baseName = currentFileName.replace(/\.[^/.]+$/, "");
            const txtFileName = `informe_calidad_datos_${baseName}.txt`;
            
            // Crear blob y descargar
            const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = txtFileName;
            
            // Simular clic para descargar
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // Mostrar mensaje en consola
            addConsoleMessage(`Informe guardado en: ${txtFileName}`, 'success');
            
            // Mostrar secci√≥n de descarga con opci√≥n para volver a descargar
            downloadSection.style.display = 'block';
            downloadTxtBtn.onclick = () => downloadTxtReport();
            
            return true;
        }

        // Funci√≥n para limpiar archivo
        function clearFile() {
            fileInput.value = '';
            fileInfo.classList.remove('show');
            downloadSection.style.display = 'none';
            
            // Limpiar consola
            consoleMessages = [
                { 
                    message: "‚ñ∂ SISTEMA DE AN√ÅLISIS DE CALIDAD DE DATOS INICIADO\nVersi√≥n 1.0 ‚Ä¢ An√°lisis exhaustivo de datos", 
                    type: 'info',
                    timestamp: new Date()
                },
                { 
                    message: "‚ñ∂ Por favor, suba un archivo CSV o Excel para generar un informe de calidad de datos:", 
                    type: 'info',
                    timestamp: new Date()
                }
            ];
            
            updateConsoleDisplay();
            
            currentData = null;
            currentFileName = '';
            currentFileExtension = '';
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Sistema de An√°lisis de Calidad de Datos - An√°lisis exhaustivo de datos');
        });

        // Funci√≥n para crear datos de ejemplo (solo para demostraci√≥n)
        function createExampleData() {
            const exampleData = [];
            
            // Crear datos de ejemplo similares al informe
            const data = [
                ['CC', 'Nombre completo', 'Puesto de votaci√≥n', 'Mesa de votaci√≥n'],
                ['1123456789.0', 'Juan P√©rez', 'Colegio Nacional', '1'],
                ['2001234567.0', 'Maria Garc√≠a', 'Colegio Nacional', '2'],
                ['2556789012.0', 'Carlos L√≥pez', 'Escuela Primaria', '3A'],
                ['2667890123.0', 'Ana Rodr√≠guez', 'Escuela Primaria', '3B'],
                ['3212345678.0', 'Luis Mart√≠nez', 'Colegio Municipal', '4'],
                ['1123456789.0', 'Juan P√©rez', 'Colegio Nacional', '1'],
                ['2001234567.0', 'Maria Garc√≠a', '', '2'],
                ['2556789012.0', 'Carlos L√≥pez', 'Escuela Primaria', '3'],
                ['2667890123.0', 'Ana Rodr√≠guez', 'Escuela Primaria', ''],
                ['3212345678.0', 'Luis Mart√≠nez', 'Colegio Municipal', '4'],
                ['1123456789.0', 'Pedro S√°nchez', 'Colegio Nacional', '1']
            ];
            
            // Agregar m√°s filas para llegar a 31
            for (let i = 12; i < 31; i++) {
                const cc = (4000000000 + i).toString() + '.0';
                const nombre = `Persona ${i + 1}`;
                const puesto = `Puesto ${Math.floor(i/5) + 1}`;
                const mesa = i % 2 === 0 ? `${Math.floor(i/2) + 1}` : `${Math.floor(i/2) + 1}A`;
                data.push([cc, nombre, puesto, mesa]);
            }
            
            // Hacer que algunas filas tengan valores faltantes
            data[27][0] = ''; // CC faltante en fila 28
            data[28][1] = ''; // Nombre faltante en fila 29
            data[29][2] = ''; // Puesto faltante en fila 30
            data[30][3] = ''; // Mesa faltante en fila 31
            
            const csvContent = data.map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'datos_ejemplo_votantes.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>